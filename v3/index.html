<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1A1A1A">
    <title>대장간 V3</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
    <div class="app-container">
        <!-- Header with Global Navigation -->
        <header class="app-header">
            <div class="logo" onclick="app.goToStep(1)">대장간 <span class="version">V4</span></div>
            <nav class="global-nav">
                <span class="nav-item active" onclick="app.goToStep(1)" id="navStep1">설정</span>
                <span class="nav-item" onclick="app.goToStep(2)" id="navStep2">입력</span>
                <span class="nav-item" onclick="app.goToStep(3)" id="navStep3">결과</span>
            </nav>
        </header>

        <!-- Step 1: Config -->
        <section class="screen active" id="step1">
            <div class="screen-content">
                <div class="screen-intro">
                    <h2 class="screen-title">원판 크기</h2>
                    <p class="section-subtitle">재단할 원판 사이즈를 입력하세요</p>
                </div>

                <!-- Board Input Fields (One Row) -->
                <div class="input-display board-input-row">
                    <div class="input-field active" data-board-field="boardWidth">
                        <span class="field-label">가로</span>
                        <div class="field-value-wrap">
                            <span class="field-value" id="displayBoardWidth">2440</span>
                            <span class="field-unit">mm</span>
                        </div>
                    </div>
                    <div class="input-separator-x">×</div>
                    <div class="input-field" data-board-field="boardHeight">
                        <span class="field-label">세로</span>
                        <div class="field-value-wrap">
                            <span class="field-value" id="displayBoardHeight">1220</span>
                            <span class="field-unit">mm</span>
                        </div>
                    </div>
                </div>

                <!-- Grain Toggle -->
                <div class="config-toggle-item" id="grainToggleStep1">
                    <div class="toggle-info">
                        <span class="toggle-icon">🌾</span>
                        <div class="toggle-text">
                            <span class="toggle-title">결고려</span>
                            <span class="toggle-desc">나무결 방향 맞춰 배치</span>
                        </div>
                    </div>
                    <div class="toggle-switch-wrap">
                        <input type="checkbox" id="grainCheckboxStep1" class="hidden-checkbox">
                        <div class="custom-toggle"></div>
                    </div>
                </div>

                <!-- Preview Area -->
                <div class="board-preview-area">
                    <div class="preview-placeholder">
                        <span class="placeholder-icon">📐</span>
                        <span class="placeholder-text">원판 프리뷰</span>
                    </div>
                    <canvas id="step1PreviewCanvas" class="hidden"></canvas>
                </div>

                <!-- Hidden inputs for logic compatibility -->
                <input type="number" id="boardWidth" value="2440" class="hidden">
                <input type="number" id="boardHeight" value="1220" class="hidden">
                <input type="checkbox" id="useGrain" class="hidden">
            </div>

            <div class="screen-footer">
                <button class="btn btn-primary btn-lg" id="toStep2Btn">
                    다음: 부품 입력 →
                </button>
            </div>
        </section>

        <!-- Step 2: Parts Input -->
        <section class="screen" id="step2">
            <div class="screen-content fixed-layout">
                <header class="screen-header-simple">
                    <h2 class="screen-title-small">절단 입력</h2>
                    <div class="parts-count-badge" id="partsCount">절단 0개</div>
                </header>

                <!-- Expanded Parts List (Dominant Area) -->
                <div class="parts-section-expanded">
                    <div class="parts-header-mini">
                        <span class="section-lbl">목록</span>
                        <button class="link-btn-danger" id="clearAllBtn">전체삭제</button>
                    </div>
                    <div class="parts-list-scroll" id="partsList">
                        <!-- Empty State Placeholder -->
                        <div class="empty-state" id="emptyState">
                            <span class="empty-icon">📦</span>
                            <span class="empty-text">아직 부품이 없습니다</span>
                            <span class="empty-hint">아래에서 추가해주세요 ↓</span>
                        </div>
                    </div>
                </div>

                <!-- Run Optimization (Floating above input bar) -->
                <div class="calculate-action-area">
                    <button class="btn btn-calculate-main" id="calculateBtn">최적화 실행</button>
                </div>
            </div>

            <!-- FIXED BOTTOM INPUT BAR (v4) -->
            <div class="bottom-input-bar">
                <div class="input-row-fixed">
                    <!-- Width Input -->
                    <div class="input-box-compact" data-field="width">
                        <span class="box-label">가로</span>
                        <span class="box-value" id="inputWidth">800</span>
                        <span class="box-unit">mm</span>
                    </div>

                    <div class="input-separator-x">×</div>

                    <!-- Height Input -->
                    <div class="input-box-compact" data-field="height">
                        <span class="box-label">세로</span>
                        <span class="box-value" id="inputHeight">400</span>
                        <span class="box-unit">mm</span>
                    </div>

                    <div class="input-separator-x">×</div>

                    <!-- Quantity Input -->
                    <div class="input-box-compact" data-field="qty">
                        <span class="box-label">개수</span>
                        <span class="box-value" id="inputQty">1</span>
                        <span class="box-unit">개</span>
                    </div>

                    <!-- Grain Toggle (Square/Compact) -->
                    <div class="config-toggle-compact" id="grainToggle">
                        <span class="toggle-icon-mini">≡≡</span>
                    </div>

                    <!-- Add Button -->
                    <button class="btn btn-add-compact" id="addPartBtn">추가</button>
                </div>
            </div>

            <!-- Hidden inputs remain for logic compatibility -->
            <input type="checkbox" id="partRotatable" checked class="hidden">
        </section>

        <!-- Custom Keypad (Popup Style) -->
        <div class="keypad-popup-overlay hidden" id="keypadOverlay">
            <div class="keypad-popup">
                <!-- Large Input Display Area -->
                <div class="keypad-display-section">
                    <div class="keypad-field-name" id="keypadFieldLabel">가로</div>
                    <div class="keypad-large-value">
                        <span id="keypadPreview">0</span><span class="unit">mm</span>
                    </div>
                    <div class="validation-warning" id="validationWarning"></div>
                </div>

                <div class="keypad-grid">
                    <button class="key" data-key="1">1</button>
                    <button class="key" data-key="2">2</button>
                    <button class="key" data-key="3">3</button>
                    <button class="key" data-key="4">4</button>
                    <button class="key" data-key="5">5</button>
                    <button class="key" data-key="6">6</button>
                    <button class="key" data-key="7">7</button>
                    <button class="key" data-key="8">8</button>
                    <button class="key" data-key="9">9</button>
                    <button class="key key-back" data-key="←">←</button>
                    <button class="key" data-key="0">0</button>
                    <button class="key key-confirm" data-key="done">✓</button>
                </div>
            </div>
        </div>

        <!-- Step 3: Results (Bottom Sheet Style) -->
        <section class="screen result-screen" id="step3">
            <div class="result-content">
                <!-- Top Summary Bar -->
                <div class="result-summary-bar">
                    <div class="summary-card">
                        <span class="summary-icon">💰</span>
                        <span class="summary-val" id="statCost">0원</span>
                        <span class="summary-lbl">예상 비용</span>
                    </div>
                    <div class="summary-card">
                        <span class="summary-icon">✂️</span>
                        <span class="summary-val" id="statCuts">0회</span>
                        <span class="summary-lbl">절단 횟수</span>
                    </div>
                    <div class="summary-card">
                        <span class="summary-icon">📦</span>
                        <span class="summary-val" id="statBoards">0장</span>
                        <span class="summary-lbl">사용 원판</span>
                    </div>
                </div>

                <div class="result-inner">
                    <div class="result-canvas-wrapper">
                        <canvas id="resultCanvas"></canvas>
                    </div>

                    <div class="canvas-controls">
                        <button class="canvas-ctrl" id="prevBoard">◀</button>
                        <span class="board-indicator" id="boardIndicator">1/1</span>
                        <button class="canvas-ctrl" id="nextBoard">▶</button>
                    </div>

                    <!-- UI2: Legend for small parts -->
                    <div class="legend-section" id="legendSection"></div>
                </div>
            </div>

            <div class="screen-footer triple">
                <button class="btn btn-secondary" id="backToInputBtn">← 다시입력</button>
                <button class="btn btn-share" id="shareBtn">📤 공유</button>
                <button class="btn btn-primary" id="downloadPdfBtn">📄 PDF</button>
            </div>
        </section>
    </div>

    <!-- PDF Preview Modal -->
    <div class="pdf-modal-overlay hidden" id="pdfModal">
        <div class="pdf-modal">
            <div class="pdf-modal-header">
                <span class="logo">대장간 <span class="version">V4</span></span>
                <button class="pdf-close-btn" id="pdfCloseBtn">×</button>
            </div>

            <!-- Statistical Summary Bar (Same as Step 3) -->
            <div class="result-summary-bar pdf-summary-bar">
                <div class="summary-card">
                    <span class="summary-icon">💰</span>
                    <span class="summary-val" id="pdfStatCost">0원</span>
                </div>
                <div class="summary-card">
                    <span class="summary-icon">✂️</span>
                    <span class="summary-val" id="pdfStatCuts">0회</span>
                </div>
                <div class="summary-card">
                    <span class="summary-icon">📦</span>
                    <span class="summary-val" id="pdfStatBoards">0장</span>
                </div>
            </div>

            <div class="pdf-modal-content" id="pdfScrollContainer">
                <div class="pdf-preview-list" id="pdfPreviewList">
                    <!-- Multiple canvases will be injected here -->
                </div>
            </div>

            <div class="pdf-modal-footer">
                <div class="pdf-actions-row">
                    <button class="btn btn-secondary btn-flex" id="pdfDownloadBtn">📥 저장</button>
                    <button class="btn btn-primary btn-flex" id="pdfShareBtn">📤 공유</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/packer.js"></script>
    <script src="js/renderer.js"></script>
    <script src="js/app.js"></script>
</body>

</html>
```